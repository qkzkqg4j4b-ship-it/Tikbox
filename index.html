<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/qkzkqg4j4b-ship-it/Tikbox/refs/heads/main/IMG_8203.jpeg">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="icon" sizes="192x192" href="https://raw.githubusercontent.com/qkzkqg4j4b-ship-it/Tikbox/refs/heads/main/IMG_8203.jpeg">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Tikbox">

    <title>Tikbox v5.3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        
        body {
            font-family: 'Noto Sans TC', -apple-system, sans-serif;
            background-color: #FDFBF7;
            color: #4A3F35;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
            user-select: none;
        }

        .folder-strip {
            background: #FFFFFF;
            border-radius: 22px;
            border: 1px solid #F0EDE8;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s ease;
            margin-bottom: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.01);
        }
        .folder-strip:active { transform: scale(0.97); background-color: #FAFAFA; }

        .emoji-icon {
            width: 44px; height: 44px;
            display: flex; align-items: center; justify-content: center;
            font-size: 22px; border-radius: 14px; background: #FDF8F0;
            flex-shrink: 0;
        }

        .swipe-container {
            position: relative; overflow: hidden; border-radius: 24px;
            touch-action: pan-y; margin-bottom: 1rem;
        }

        .swipe-content {
            position: relative; background: #FFFFFF; z-index: 2;
            transition: transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            border: 1px solid #F0EDE8; border-radius: 24px;
        }

        .swipe-action {
            position: absolute; right: 0; top: 0; height: 100%; width: 80px;
            background: #FF4B4B; color: white; display: flex; align-items: center;
            justify-content: center; z-index: 1; border-radius: 0 24px 24px 0;
        }

        .tab-btn { color: #D1D5DB; font-weight: 700; position: relative; padding-bottom: 8px; transition: all 0.3s; }
        .tab-btn.active { color: #F59E0B; font-weight: 900; }
        .tab-btn.active::after {
            content: ''; position: absolute; bottom: -2px; left: 50%; transform: translateX(-50%);
            width: 16px; height: 4px; background: #F59E0B; border-radius: 10px;
        }

        .add-btn { background: #F59E0B; box-shadow: 0 10px 30px rgba(245, 158, 11, 0.4); }
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        #image-lightbox {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95);
            z-index: 100; touch-action: none; flex-direction: column;
            align-items: center; justify-content: center; overflow: hidden;
        }
        #lightbox-img { 
            max-width: 100%; 
            max-height: 100%; 
            transform-origin: center;
            transition: transform 0.1s ease-out;
            will-change: transform;
        }

        .sn-display-box {
            display: flex; align-items: center; gap: 6px;
            background: #F8F9FA; padding: 4px 10px; border-radius: 8px;
            border: 1px solid #EDF2F7; margin-top: 4px; cursor: pointer;
            width: fit-content;
        }

        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background-color: #E2E8F0; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #F59E0B; }
        input:checked + .slider:before { transform: translateX(20px); }

        .quick-tag {
            width: 44px; height: 44px; border-radius: 12px; background: #F7F5F2;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; transition: all 0.2s; border: 2px solid transparent;
            flex-shrink: 0;
        }
        .quick-tag.selected { background: #FEF3C7; color: #F59E0B; border-color: #FDE68A; }

        .date-input-container {
            position: relative; background: #F8F6F2; border-radius: 16px; padding: 14px 16px; margin-top: 8px;
            display: flex; align-items: center; justify-content: space-between; min-height: 56px;
        }
        .native-date-input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 10; }
    </style>
</head>
<body class="safe-pb">

    <svg style="display: none;">
        <symbol id="icon-plus" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></symbol>
        <symbol id="icon-trash" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></symbol>
        <symbol id="icon-coins" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="8" cy="8" r="6"></circle><path d="M18.09 10.37A6 6 0 1 1 10.34 18"></path><path d="M7 6h1v4"></path></symbol>
        <symbol id="icon-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></symbol>
        <symbol id="icon-chevron-left" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></symbol>
        <symbol id="icon-chevron-right" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></symbol>
        <symbol id="icon-edit" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></symbol>
        <symbol id="icon-x" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></symbol>
        <symbol id="icon-copy" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></symbol>
    </svg>

    <!-- åœ–ç‰‡ç‡ˆç®± -->
    <div id="image-lightbox">
        <div id="lightbox-img-container" class="w-full h-full flex items-center justify-center">
            <img id="lightbox-img" src="" style="transform: scale(1) translate(0px, 0px);">
        </div>
        <div class="absolute top-0 left-0 w-full p-6 flex justify-between items-center bg-gradient-to-b from-black/60 to-transparent">
            <div><p id="lightbox-title" class="text-white font-black text-sm"></p></div>
            <button onclick="closeLightbox()" class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-white backdrop-blur-md">
                <svg class="w-6 h-6" stroke="currentColor"><use xlink:href="#icon-x"></use></svg>
            </button>
        </div>
    </div>

    <div id="app" class="max-w-md mx-auto min-h-screen flex flex-col">
        <header class="px-7 pt-14 pb-8 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <button id="back-btn" onclick="goHome()" class="hidden w-11 h-11 rounded-full bg-white border border-gray-100 flex items-center justify-center shadow-sm">
                    <svg class="w-5 h-5 text-[#4A3F35]"><use xlink:href="#icon-chevron-left"></use></svg>
                </button>
                <div onclick="goHome()" class="flex items-center gap-3 cursor-pointer">
                    <img src="https://raw.githubusercontent.com/qkzkqg4j4b-ship-it/Tikbox/refs/heads/main/IMG_8203.jpeg" class="w-12 h-12 rounded-full border-2 border-amber-500 p-0.5 object-cover">
                    <div>
                        <p class="text-[11px] font-black text-amber-500 uppercase tracking-[2px] mb-0.5">æˆ‘çš„ç¥¨å€‰</p>
                        <h1 class="text-2xl font-black text-[#4A3F35] tracking-tighter">Tikbox</h1>
                    </div>
                </div>
            </div>
        </header>

        <main id="home-view" class="flex-1 px-6 pb-32">
            <!-- é»æ•¸å€å¡Š -->
            <div class="mb-10">
                <div class="flex justify-between items-center mb-5 px-1">
                    <h2 class="text-xs font-black text-gray-400 uppercase tracking-widest">åˆ°æœŸé»æ•¸</h2>
                    <div class="flex gap-2">
                        <button onclick="togglePointHistory()" id="point-history-btn" class="text-[10px] font-bold text-gray-400 border border-gray-200 px-2.5 py-1.5 rounded-xl">æ­·å²ç´€éŒ„</button>
                        <button onclick="openPointModal()" class="text-xs font-black text-blue-600 bg-blue-50 px-3.5 py-2 rounded-xl">+ æ–°å¢</button>
                    </div>
                </div>
                <div id="point-list" class="space-y-3"></div>
            </div>

            <!-- åˆ†é¡å€å¡Š -->
            <div>
                <div class="flex justify-between items-center mb-5 px-1">
                    <h2 class="text-xs font-black text-gray-400 uppercase tracking-widest">ç¥¨åˆ¸åˆ†é¡å¤¾</h2>
                    <button onclick="openFolderModal()" class="text-xs font-black text-amber-600 bg-amber-50 px-3.5 py-2 rounded-xl">+ æ–°å¢åˆ†é¡</button>
                </div>
                <div id="folder-list" class="space-y-3"></div>
            </div>
        </main>

        <main id="folder-view" class="flex-1 px-6 pb-32 hidden">
            <div class="mb-6"><span id="current-folder-name" class="text-2xl font-black text-[#4A3F35]"></span></div>
            <nav class="flex px-2 gap-8 mb-6 overflow-x-auto no-scrollbar border-b border-gray-100">
                <button onclick="setTab('unused')" id="tab-unused" class="tab-btn active text-sm">æœªä½¿ç”¨</button>
                <button onclick="setTab('used')" id="tab-used" class="tab-btn text-sm">å·²ä½¿ç”¨</button>
                <button onclick="setTab('expired')" id="tab-expired" class="tab-btn text-sm">å·²éæœŸ</button>
            </nav>
            <div id="ticket-list" class="space-y-4"></div>
        </main>

        <button id="main-add-btn" onclick="openAddModal()" class="fixed bottom-10 right-8 w-16 h-16 add-btn text-white rounded-full flex items-center justify-center z-40 active:scale-90 transition-transform shadow-xl">
            <svg class="w-8 h-8" stroke="white"><use xlink:href="#icon-plus"></use></svg>
        </button>

        <!-- åˆ†é¡å½ˆçª— (ä¿®æ­£ç‰ˆé¢) -->
        <div id="folder-modal" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 hidden flex items-center justify-center p-6">
            <div class="bg-white w-full max-w-sm rounded-[32px] p-6 shadow-2xl overflow-hidden">
                <h3 class="text-xl font-black mb-6 text-center text-[#4A3F35]">è‡ªå®šç¾©åˆ†é¡</h3>
                <input type="hidden" id="editing-folder-id">
                
                <div class="space-y-6">
                    <!-- Emoji å¿«é€Ÿé¸å– -->
                    <div>
                        <label class="text-[10px] font-black text-amber-500 uppercase tracking-widest block mb-2">é¸å–åœ–ç¤º</label>
                        <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                            <button onclick="selectQuickTag(this, 'ğŸ”')" class="quick-tag">ğŸ”</button>
                            <button onclick="selectQuickTag(this, 'ğŸª')" class="quick-tag">ğŸª</button>
                            <button onclick="selectQuickTag(this, 'â˜•ï¸')" class="quick-tag">â˜•ï¸</button>
                            <button onclick="selectQuickTag(this, 'ğŸ¥¤')" class="quick-tag">ğŸ¥¤</button>
                            <button onclick="selectQuickTag(this, 'ğŸ«')" class="quick-tag">ğŸ«</button>
                            <button onclick="selectQuickTag(this, 'ğŸ£')" class="quick-tag">ğŸ£</button>
                            <button onclick="selectQuickTag(this, 'ğŸ¿')" class="quick-tag">ğŸ¿</button>
                        </div>
                    </div>

                    <!-- åç¨±èˆ‡è‡ªè¨‚ Emoji -->
                    <div class="space-y-4">
                        <div class="flex items-center gap-3 bg-gray-50 p-1 rounded-2xl border-2 border-transparent focus-within:border-amber-100 transition-all">
                            <input id="custom-emoji" type="text" placeholder="ğŸ˜€" maxlength="2" class="w-14 h-14 bg-white rounded-xl font-bold text-center text-xl outline-none shadow-sm flex-shrink-0">
                            <input id="new-folder-name" type="text" placeholder="åˆ†é¡åç¨±..." class="flex-1 bg-transparent py-4 pr-4 font-bold outline-none text-[#4A3F35]">
                        </div>
                    </div>
                </div>

                <div class="flex gap-3 mt-8">
                    <button onclick="closeFolderModal()" class="flex-1 py-4 bg-gray-100 rounded-2xl font-bold text-gray-400">å–æ¶ˆ</button>
                    <button onclick="saveFolder()" class="flex-1 py-4 bg-amber-500 rounded-2xl font-bold text-white shadow-lg shadow-amber-200">å„²å­˜</button>
                </div>
            </div>
        </div>

        <!-- å…¶é¤˜å½ˆçª—ä¿æŒä¸è®Šä½†ç¢ºä¿ä¸€è‡´æ€§ -->
        <div id="point-modal" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 hidden flex items-center justify-center p-8">
            <div class="bg-white w-full max-w-xs rounded-[32px] p-8 shadow-2xl">
                <h3 class="text-xl font-black mb-6 text-center">é»æ•¸ç´€éŒ„</h3>
                <input type="hidden" id="editing-point-id">
                <div class="space-y-4">
                    <input id="point-name" type="text" placeholder="åº—å®¶åç¨±" class="w-full bg-gray-50 p-4 rounded-2xl font-bold outline-none">
                    <input id="point-value" type="number" placeholder="é»æ•¸é¡åº¦" class="w-full bg-gray-50 p-4 rounded-2xl font-bold outline-none">
                    <div class="date-input-container">
                        <span id="point-date-text" class="text-sm font-bold text-gray-400">åˆ°æœŸæ—¥æœŸ</span>
                        <input id="point-expiry" type="date" class="native-date-input" onchange="document.getElementById('point-date-text').innerText=this.value">
                    </div>
                </div>
                <div class="flex gap-3 mt-8">
                    <button onclick="closePointModal()" class="flex-1 py-4 bg-gray-100 rounded-2xl font-bold text-gray-400">å–æ¶ˆ</button>
                    <button onclick="savePoint()" class="flex-1 py-4 bg-blue-500 rounded-2xl font-bold text-white">å„²å­˜</button>
                </div>
            </div>
        </div>

        <div id="ticket-modal" class="fixed inset-0 bg-white z-50 hidden overflow-y-auto">
            <div class="px-8 pt-16 pb-12">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-2xl font-black">å­˜å…¥ç¥¨åˆ¸</h2>
                    <button onclick="closeAddModal()" class="text-gray-300"><svg class="w-8 h-8"><use xlink:href="#icon-x"></use></svg></button>
                </div>
                <input type="hidden" id="editing-ticket-id">
                <div class="space-y-6">
                    <div onclick="document.getElementById('file-input').click()" class="aspect-video bg-[#F9F7F4] rounded-[32px] border-2 border-dashed border-[#EAE2D6] flex flex-col items-center justify-center overflow-hidden relative">
                        <input type="file" id="file-input" accept="image/*" class="hidden" onchange="handleFile(this)">
                        <img id="img-output" class="hidden w-full h-full object-cover">
                        <div id="upload-hint" class="text-center text-gray-300 font-black uppercase text-[10px] tracking-widest">é»æ“Šä¸Šå‚³æˆªåœ–</div>
                    </div>
                    <div class="space-y-5">
                        <div class="border-b border-gray-100 pb-2">
                            <label class="text-[10px] font-black text-amber-500 uppercase tracking-widest">å­˜æ”¾åˆ†é¡</label>
                            <select id="ticket-folder-select" class="w-full bg-transparent border-none py-1 text-lg font-black outline-none"></select>
                        </div>
                        <div class="border-b border-gray-100 pb-2">
                            <label class="text-[10px] font-black text-amber-500 uppercase tracking-widest">ç¥¨åˆ¸åç¨±</label>
                            <input id="title" type="text" placeholder="ä¾‹å¦‚ï¼šå¤§è–¯è²·ä¸€é€ä¸€" class="w-full bg-transparent border-none py-1 text-lg font-black outline-none">
                        </div>
                        <div class="border-b border-gray-100 pb-2">
                            <label class="text-[10px] font-black text-amber-500 uppercase tracking-widest">åºè™Ÿ / å‚™è¨»</label>
                            <input id="sn-input" type="text" placeholder="è¼¸å…¥åºè™Ÿæˆ–å‚™è¨»" class="w-full bg-transparent border-none py-1 text-lg font-black outline-none">
                        </div>
                        <div class="flex items-center justify-between py-2">
                            <label class="text-[10px] font-black text-amber-500 uppercase tracking-widest">ç„¡ä½¿ç”¨æœŸé™</label>
                            <label class="switch"><input type="checkbox" id="no-expiry-toggle" onchange="toggleExpiryInput()"><span class="slider"></span></label>
                        </div>
                        <div id="expiry-input-wrapper" class="date-input-container">
                            <span id="date-text" class="text-sm font-bold text-gray-400">æœ‰æ•ˆæ—¥æœŸ</span>
                            <input id="expiry" type="date" class="native-date-input" onchange="document.getElementById('date-text').innerText=this.value">
                        </div>
                    </div>
                    <button onclick="saveTicket()" class="w-full py-6 add-btn text-white rounded-[24px] font-black text-lg mt-4 shadow-xl">ç¢ºèªå„²å­˜</button>
                </div>
            </div>
        </div>

        <div id="toast" class="fixed bottom-12 left-1/2 -translate-x-1/2 bg-[#4A3F35] text-white px-8 py-3 rounded-full text-xs font-bold opacity-0 transition-all pointer-events-none z-[70]"></div>
    </div>

    <script>
        let db = JSON.parse(localStorage.getItem('tikbox_v4_db')) || { folders: [], tickets: [], points: [] };
        if (db.folders.length === 0) {
            db.folders = [
                { id: 'default', name: 'ä¸€èˆ¬ç¥¨åˆ¸ ğŸ«' },
                { id: 'other', name: 'å…¶ä»– ğŸ·ï¸' }
            ];
        }

        let currentFolderId = null, currentTab = 'unused', showPointHistory = false, tempImg = null, selectedEmoji = "";

        // --- æ ¸å¿ƒå·¥å…· ---
        function calculateRemainingDays(expiryDate) {
            if (!expiryDate) return null;
            const today = new Date(); today.setHours(0, 0, 0, 0);
            const expiry = new Date(expiryDate); expiry.setHours(0, 0, 0, 0);
            const diff = expiry.getTime() - today.getTime();
            return Math.ceil(diff / (1000 * 60 * 60 * 24));
        }

        function showToast(m) {
            const t = document.getElementById('toast'); t.innerText = m;
            t.classList.add('opacity-100');
            setTimeout(() => t.classList.remove('opacity-100'), 2000);
        }

        // --- åœ–ç‰‡ç¸®æ”¾ ---
        let scale = 1, lastScale = 1, startDistance = 0, startX = 0, startY = 0, currentX = 0, currentY = 0;
        const lightboxImg = document.getElementById('lightbox-img');
        const lightboxContainer = document.getElementById('image-lightbox');

        function zoomImage(s, t) { 
            if(!s) return; 
            lightboxImg.src = s; 
            document.getElementById('lightbox-title').innerText = t; 
            lightboxContainer.style.display = 'flex';
            scale = 1; currentX = 0; currentY = 0;
            updateImgTransform();
        }
        function closeLightbox() { lightboxContainer.style.display = 'none'; }
        function updateImgTransform() { lightboxImg.style.transform = `translate(${currentX}px, ${currentY}px) scale(${scale})`; }

        lightboxContainer.addEventListener('touchstart', e => {
            if (e.touches.length === 2) {
                startDistance = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
                lastScale = scale;
            } else if (e.touches.length === 1) {
                startX = e.touches[0].pageX - currentX;
                startY = e.touches[0].pageY - currentY;
            }
        });
        lightboxContainer.addEventListener('touchmove', e => {
            e.preventDefault();
            if (e.touches.length === 2) {
                const distance = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
                scale = Math.min(Math.max(1, lastScale * (distance / startDistance)), 4);
            } else if (e.touches.length === 1 && scale > 1) {
                currentX = e.touches[0].pageX - startX;
                currentY = e.touches[0].pageY - startY;
            }
            updateImgTransform();
        });

        // --- æ¸²æŸ“ ---
        function render() {
            const folderList = document.getElementById('folder-list');
            const pointList = document.getElementById('point-list');
            const todayStr = new Date().toISOString().split('T')[0];

            // æ¸²æŸ“é»æ•¸
            const sortedPoints = [...db.points].sort((a,b) => (a.expiry || '9999') > (b.expiry || '9999') ? 1 : -1);
            const displayPoints = sortedPoints.filter(p => showPointHistory ? p.used : !p.used);
            pointList.innerHTML = displayPoints.map(p => {
                const diff = calculateRemainingDays(p.expiry);
                return `
                    <div class="p-5 flex items-center justify-between ${p.used ? 'opacity-40 grayscale' : ''} bg-white rounded-[22px] border border-[#F0EDE8] mb-3 shadow-sm">
                        <div class="flex items-center gap-4 min-w-0">
                            <div class="w-11 h-11 ${p.used ? 'bg-gray-100' : 'bg-blue-50'} rounded-full flex items-center justify-center text-blue-500"><svg class="w-6 h-6"><use xlink:href="#icon-coins"></use></svg></div>
                            <div class="min-w-0">
                                <h4 class="font-black text-sm text-[#4A3F35] truncate">${p.name}</h4>
                                <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest">${p.expiry || 'æ°¸ä¹…'} åˆ°æœŸ</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="text-right">
                                <div class="font-black ${p.used ? 'text-gray-400' : 'text-blue-600'}">${p.value} pt</div>
                                ${!p.used && diff !== null ? `<div class="text-[10px] font-black ${diff <= 7 ? 'text-red-500' : 'text-gray-300'}">å‰© ${diff} å¤©</div>` : ''}
                            </div>
                            <button onclick="openEditPointModal('${p.id}')" class="p-2 text-gray-200"><svg class="w-4 h-4"><use xlink:href="#icon-edit"></use></svg></button>
                        </div>
                    </div>
                `;
            }).join('') || `<div class="py-10 text-center text-gray-300 font-bold text-[11px] border-2 border-dashed border-gray-100 rounded-[24px]">å°šç„¡é»æ•¸è³‡æ–™</div>`;

            // æ¸²æŸ“åˆ†é¡
            folderList.innerHTML = db.folders.map(f => {
                const count = db.tickets.filter(t => t.folderId === f.id && !t.used).length;
                const emoji = f.name.match(/(\u00a9|\u00ae|[\u2000-\u3300]|\ud83c[\ud000-\udfff]|\ud83d[\ud000-\udfff]|\ud83e[\ud000-\udfff])/)?.[0] || "ğŸ·ï¸";
                const nameOnly = f.name.replace(emoji, "").trim();
                return `
                    <div onclick="openFolder('${f.id}')" class="folder-strip cursor-pointer">
                        <div class="flex items-center gap-4 min-w-0">
                            <div class="emoji-icon">${emoji}</div>
                            <div class="truncate">
                                <h3 class="font-black text-sm text-[#4A3F35] truncate">${nameOnly}</h3>
                                <p class="text-[10px] font-black text-gray-300 uppercase tracking-widest">${count} å¼µå¯ç”¨</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-1 flex-shrink-0">
                            <button onclick="event.stopPropagation(); openFolderModal('${f.id}')" class="p-2 text-gray-200 hover:text-amber-500"><svg class="w-4 h-4"><use xlink:href="#icon-edit"></use></svg></button>
                            ${(f.id !== 'default' && f.id !== 'other') ? `<button onclick="event.stopPropagation(); deleteFolder('${f.id}')" class="p-2 text-gray-100 hover:text-red-300"><svg class="w-4 h-4"><use xlink:href="#icon-trash"></use></svg></button>` : ''}
                            <svg class="w-5 h-5 text-gray-200"><use xlink:href="#icon-chevron-right"></use></svg>
                        </div>
                    </div>
                `;
            }).join('');

            // æ¸²æŸ“ç¥¨åˆ¸æ¸…å–®
            if (currentFolderId) {
                const filtered = db.tickets.filter(t => {
                    if (t.folderId !== currentFolderId) return false;
                    const expired = !t.noExpiry && t.expiry && t.expiry < todayStr;
                    if (currentTab === 'expired') return expired && !t.used;
                    if (currentTab === 'used') return t.used;
                    return !t.used && !expired;
                });
                filtered.sort((a, b) => (a.noExpiry ? 1 : 0) - (b.noExpiry ? 1 : 0) || (a.expiry || '9').localeCompare(b.expiry || '9'));
                
                document.getElementById('ticket-list').innerHTML = filtered.map(t => {
                    const diff = calculateRemainingDays(t.expiry);
                    return `
                        <div class="swipe-container" id="container-${t.id}">
                            <div class="swipe-action" onclick="deleteTicket('${t.id}')"><svg class="w-6 h-6"><use xlink:href="#icon-trash"></use></svg></div>
                            <div class="swipe-content p-5" id="content-${t.id}" ontouchstart="handleItemTouchStart(event,'${t.id}')" ontouchmove="handleItemTouchMove(event,'${t.id}')" ontouchend="handleItemTouchEnd(event,'${t.id}')">
                                <div class="flex items-center gap-4">
                                    <div class="w-16 h-16 rounded-2xl overflow-hidden bg-gray-50 flex-shrink-0 border border-gray-100" onclick="zoomImage('${t.image || ''}','${t.title}')">
                                        ${t.image ? `<img src="${t.image}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center bg-amber-50 text-amber-500 font-black text-lg">${t.title.charAt(0)}</div>`}
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <h4 class="text-base font-black text-[#4A3F35] truncate">${t.title}</h4>
                                        <p class="text-[11px] font-black text-amber-500">${t.noExpiry ? 'ç„¡æœŸé™' : (t.expiry || 'æœªè¨­æ—¥æœŸ')}</p>
                                        ${t.sn ? `<div class="sn-display-box" onclick="copySN('${t.sn}')"><svg class="w-3 h-3 text-gray-400"><use xlink:href="#icon-copy"></use></svg><span class="text-[11px] font-bold text-gray-500 truncate max-w-[100px]">${t.sn}</span></div>` : ''}
                                    </div>
                                    <div class="flex flex-col items-end gap-2">
                                        ${!t.noExpiry && diff !== null ? `<span class="text-[10px] font-black px-2 py-1 rounded-lg ${diff <= 7 ? 'text-red-500 bg-red-50' : 'text-gray-400 bg-gray-50'}">${diff < 0 ? 'å·²éæœŸ' : `å‰© ${diff} å¤©`}</span>` : ''}
                                        <div class="flex gap-1">
                                            <button onclick="openEditModal('${t.id}')" class="w-9 h-9 rounded-full flex items-center justify-center bg-gray-50 text-gray-200"><svg class="w-4 h-4"><use xlink:href="#icon-edit"></use></svg></button>
                                            <button onclick="toggleUsed('${t.id}')" class="w-9 h-9 rounded-full flex items-center justify-center ${t.used ? 'bg-green-500 text-white' : 'bg-amber-500 text-white shadow-md'}"><svg class="w-4 h-4"><use xlink:href="#icon-check"></use></svg></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('') || `<div class="py-24 text-center text-gray-300 font-black text-sm">æ­¤æ¨™ç±¤å°šç„¡ç¥¨åˆ¸</div>`;
            }
            document.getElementById('ticket-folder-select').innerHTML = db.folders.map(f => `<option value="${f.id}" ${f.id === currentFolderId ? 'selected' : ''}>${f.name}</option>`).join('');
            localStorage.setItem('tikbox_v4_db', JSON.stringify(db));
        }

        // --- åˆ†é¡èˆ‡ç´°ç¯€æ§åˆ¶ ---
        function openFolderModal(id = null) {
            const modal = document.getElementById('folder-modal');
            const customEmoji = document.getElementById('custom-emoji');
            modal.classList.remove('hidden');
            document.querySelectorAll('.quick-tag').forEach(t => t.classList.remove('selected'));
            selectedEmoji = "";

            if(id) {
                const f = db.folders.find(x => x.id === id);
                document.getElementById('editing-folder-id').value = f.id;
                const emoji = f.name.match(/(\u00a9|\u00ae|[\u2000-\u3300]|\ud83c[\ud000-\udfff]|\ud83d[\ud000-\udfff]|\ud83e[\ud000-\udfff])/)?.[0] || "";
                document.getElementById('new-folder-name').value = f.name.replace(emoji, "").trim();
                customEmoji.value = emoji;
                selectedEmoji = emoji;
            } else {
                document.getElementById('editing-folder-id').value = "";
                document.getElementById('new-folder-name').value = "";
                customEmoji.value = "ğŸ·ï¸";
            }
        }
        function closeFolderModal() { document.getElementById('folder-modal').classList.add('hidden'); }
        function selectQuickTag(btn, emoji) {
            document.querySelectorAll('.quick-tag').forEach(t => t.classList.remove('selected'));
            btn.classList.add('selected');
            selectedEmoji = emoji;
            document.getElementById('custom-emoji').value = emoji;
        }
        function saveFolder() {
            const name = document.getElementById('new-folder-name').value.trim();
            const customE = document.getElementById('custom-emoji').value.trim();
            const id = document.getElementById('editing-folder-id').value;
            if(!name) return;
            const finalName = `${name} ${customE || 'ğŸ·ï¸'}`;
            if(id) db.folders.find(x=>x.id===id).name = finalName;
            else db.folders.push({id:Date.now().toString(), name:finalName});
            render(); closeFolderModal();
        }
        function deleteFolder(id) { if(confirm('åˆªé™¤å¾Œå…§çš„ç¥¨åˆ¸ä¹Ÿæœƒæ¶ˆå¤±ï¼Œç¢ºå®šå—ï¼Ÿ')) { db.folders=db.folders.filter(x=>x.id!==id); db.tickets=db.tickets.filter(x=>x.folderId!==id); render(); } }

        // --- å…¶ä»–åŠŸèƒ½å‡½æ•¸ (Tab, SN, Add, Save etc.) ---
        function setTab(tab) { currentTab = tab; document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.toggle('active', btn.id === `tab-${tab}`)); render(); }
        function copySN(text) { const el = document.createElement('textarea'); el.value = text; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el); showToast('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿'); }
        function toggleExpiryInput() { const wrapper = document.getElementById('expiry-input-wrapper'); const nx = document.getElementById('no-expiry-toggle').checked; wrapper.style.opacity = nx ? '0.3' : '1'; wrapper.style.pointerEvents = nx ? 'none' : 'auto'; }
        function openPointModal() { document.getElementById('editing-point-id').value=""; document.getElementById('point-modal').classList.remove('hidden'); }
        function closePointModal() { document.getElementById('point-modal').classList.add('hidden'); }
        function savePoint() { const id=document.getElementById('editing-point-id').value, n=document.getElementById('point-name').value, v=document.getElementById('point-value').value, e=document.getElementById('point-expiry').value; if(!n||!v) return; if(id) { const p=db.points.find(x=>x.id===id); p.name=n; p.value=v; p.expiry=e; } else db.points.push({id:Date.now().toString(), name:n, value:v, expiry:e, used:false}); render(); closePointModal(); }
        function openEditPointModal(id) { const p=db.points.find(x=>x.id===id); document.getElementById('editing-point-id').value=p.id; document.getElementById('point-name').value=p.name; document.getElementById('point-value').value=p.value; document.getElementById('point-expiry').value=p.expiry; document.getElementById('point-modal').classList.remove('hidden'); }
        function togglePointHistory() { showPointHistory=!showPointHistory; render(); }
        function openAddModal() { document.getElementById('editing-ticket-id').value=""; document.getElementById('title').value=""; document.getElementById('sn-input').value=""; tempImg=null; document.getElementById('img-output').classList.add('hidden'); document.getElementById('upload-hint').classList.remove('hidden'); document.getElementById('ticket-modal').classList.remove('hidden'); }
        function openEditModal(id) { const t=db.tickets.find(x=>x.id===id); document.getElementById('editing-ticket-id').value=t.id; document.getElementById('title').value=t.title; document.getElementById('sn-input').value=t.sn||""; document.getElementById('expiry').value=t.expiry||""; document.getElementById('no-expiry-toggle').checked=t.noExpiry||false; tempImg=t.image; if(tempImg){ document.getElementById('img-output').src=tempImg; document.getElementById('img-output').classList.remove('hidden'); document.getElementById('upload-hint').classList.add('hidden'); } toggleExpiryInput(); document.getElementById('ticket-modal').classList.remove('hidden'); }
        function closeAddModal() { document.getElementById('ticket-modal').classList.add('hidden'); }
        function saveTicket() { const id=document.getElementById('editing-ticket-id').value, t=document.getElementById('title').value, s=document.getElementById('sn-input').value, f=document.getElementById('ticket-folder-select').value, e=document.getElementById('expiry').value, nx=document.getElementById('no-expiry-toggle').checked; if(!t) return; const data={id:id||Date.now().toString(), title:t, sn:s, folderId:f, expiry:e, noExpiry:nx, image:tempImg, used:false}; if(id) { const idx=db.tickets.findIndex(x=>x.id===id); data.used=db.tickets[idx].used; db.tickets[idx]=data; } else db.tickets.push(data); render(); closeAddModal(); }
        function toggleUsed(id) { const t=db.tickets.find(x=>x.id===id); t.used=!t.used; render(); }
        function deleteTicket(id) { db.tickets=db.tickets.filter(x=>x.id!==id); render(); }
        function handleFile(i) { const r=new FileReader(); r.onload=e=>{tempImg=e.target.result; document.getElementById('img-output').src=tempImg; document.getElementById('img-output').classList.remove('hidden'); document.getElementById('upload-hint').classList.add('hidden');}; r.readAsDataURL(i.files[0]); }
        function openFolder(id) { currentFolderId=id; const f=db.folders.find(x=>x.id===id); document.getElementById('current-folder-name').innerText=f.name; document.getElementById('back-btn').classList.remove('hidden'); document.getElementById('home-view').classList.add('hidden'); document.getElementById('folder-view').classList.remove('hidden'); setTab('unused'); }
        function goHome() { currentFolderId=null; document.getElementById('back-btn').classList.add('hidden'); document.getElementById('home-view').classList.remove('hidden'); document.getElementById('folder-view').classList.add('hidden'); render(); }
        
        // æ»‘å‹•åˆªé™¤æ‰‹å‹¢
        let itemStartX=0;
        function handleItemTouchStart(e,id){itemStartX=e.touches[0].clientX;}
        function handleItemTouchMove(e,id){let x=e.touches[0].clientX-itemStartX; if(x<-100)x=-100; if(x>0)x=0; document.getElementById(`content-${id}`).style.transform=`translateX(${x}px)`;}
        function handleItemTouchEnd(e,id){const c=document.getElementById(`content-${id}`); if(e.changedTouches[0].clientX-itemStartX<-50) c.style.transform='translateX(-80px)'; else c.style.transform='translateX(0)';}

        window.onload = render;
    </script>
</body>
</html>
