<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <link rel="apple-touch-icon" href="https://img.icons8.com/parakeet/300/F59E0B/ticket.png">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="icon" sizes="192x192" href="https://img.icons8.com/parakeet/300/F59E0B/ticket.png">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="TikBox">

    <title>TikBox</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        
        body {
            font-family: 'Noto Sans TC', -apple-system, sans-serif;
            background-color: #FDFBF7;
            color: #4A3F35;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }

        .folder-card {
            background: #FFFFFF;
            border-radius: 24px;
            border: 1px solid #F0EDE8;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03);
            transition: all 0.2s ease;
        }
        .folder-card:active { transform: scale(0.96); }

        .swipe-container {
            position: relative;
            overflow: hidden;
            border-radius: 20px;
            touch-action: pan-y;
            margin-bottom: 1rem;
        }

        .swipe-content {
            position: relative;
            background: #FFFFFF;
            z-index: 2;
            transition: transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            border: 1px solid #F0EDE8;
            border-radius: 20px;
        }

        .swipe-action {
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            width: 80px;
            background: #FF4B4B;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
            border-radius: 0 20px 20px 0;
        }

        .urgent-badge { animation: pulse-red 2s infinite; }
        @keyframes pulse-red { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .tab-active { color: #F59E0B; font-weight: 700; }
        .tab-active::after {
            content: ''; position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%);
            width: 20px; height: 3px; background: #F59E0B; border-radius: 10px;
        }

        .add-btn { background: #F59E0B; box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3); }
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .avatar-0 { background-color: #FEF3C7; color: #D97706; }
        .avatar-1 { background-color: #DBEAFE; color: #2563EB; }
        .avatar-2 { background-color: #D1FAE5; color: #059669; }
        .avatar-3 { background-color: #F3E8FF; color: #9333EA; }

        #image-lightbox {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            z-index: 100;
            backdrop-filter: blur(10px);
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        #image-lightbox img {
            max-width: 100%;
            max-height: 80vh;
            border-radius: 12px;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }

        .toggle-dot { transition: all 0.3s ease; }
        input:checked ~ .toggle-dot { transform: translateX(100%); background-color: #F59E0B; }
        input:checked ~ .toggle-bg { background-color: #FEF3C7; border-color: #FDE68A; }

        .date-input-container {
            position: relative; background: #F8F6F2; border-radius: 16px; padding: 14px 16px; margin-top: 8px;
            display: flex; align-items: center; justify-content: space-between; min-height: 56px;
        }
        .native-date-input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 10; }
    </style>
</head>
<body class="safe-pb">

    <svg style="display: none;">
        <symbol id="icon-plus" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></symbol>
        <symbol id="icon-trash" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></symbol>
        <symbol id="icon-folder" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></symbol>
        <symbol id="icon-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></symbol>
        <symbol id="icon-chevron-left" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></symbol>
        <symbol id="icon-calendar" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></symbol>
        <symbol id="icon-image" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></symbol>
        <symbol id="icon-edit" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></symbol>
        <symbol id="icon-x" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></symbol>
    </svg>

    <div id="image-lightbox" onclick="closeLightbox()">
        <img id="lightbox-img" src="">
        <p class="text-white mt-6 font-bold text-sm bg-black/50 px-6 py-2 rounded-full">點擊任何處關閉</p>
    </div>

    <div id="app" class="max-w-md mx-auto min-h-screen flex flex-col">
        <header class="px-7 pt-12 pb-6 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <button id="back-btn" onclick="goHome()" class="hidden w-10 h-10 rounded-full bg-white border border-gray-100 flex items-center justify-center shadow-sm">
                    <svg class="w-5 h-5 text-[#4A3F35]"><use xlink:href="#icon-chevron-left"></use></svg>
                </button>
                <div onclick="goHome()" class="cursor-pointer">
                    <p id="app-subtitle" class="text-[0.75rem] font-bold text-amber-500 uppercase opacity-80 mb-0.5">我的票券管家</p>
                    <h1 id="app-title" class="text-3xl font-black text-[#4A3F35] tracking-tight transition-all">TikBox</h1>
                </div>
            </div>
            <div id="breadcrumb" class="hidden text-sm font-bold">
                <span id="current-folder-name" class="text-amber-600 bg-amber-50 px-3 py-1 rounded-lg"></span>
            </div>
        </header>

        <main id="home-view" class="flex-1 px-6 pb-32">
            <div class="flex justify-between items-center mb-5 px-1">
                <h2 class="text-sm font-black text-gray-400 uppercase tracking-widest">票券分類夾</h2>
                <button onclick="openFolderModal()" class="text-sm font-bold text-amber-600 bg-amber-50 px-3 py-1.5 rounded-xl">+ 新增</button>
            </div>
            <div id="folder-grid" class="grid grid-cols-2 gap-4"></div>
        </main>

        <main id="folder-view" class="flex-1 px-6 pb-32 hidden">
            <nav class="flex px-2 gap-8 mb-6 overflow-x-auto no-scrollbar border-b border-gray-100 pb-3">
                <button onclick="setTab('unused')" id="btn-unused" class="text-sm font-bold transition-all relative tab-active">未使用</button>
                <button onclick="setTab('used')" id="btn-used" class="text-sm font-bold text-gray-300 transition-all relative">已使用</button>
                <button onclick="setTab('expired')" id="btn-expired" class="text-sm font-bold text-gray-300 transition-all relative">已過期</button>
            </nav>
            <div id="ticket-list" class="space-y-4"></div>
        </main>

        <button id="main-add-btn" onclick="openAddModal()" class="fixed bottom-10 right-8 w-16 h-16 add-btn text-white rounded-full flex items-center justify-center z-40 active:scale-90 transition-transform">
            <svg class="w-8 h-8" stroke="white"><use xlink:href="#icon-plus"></use></svg>
        </button>

        <div id="folder-modal" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 hidden flex items-center justify-center p-8">
            <div class="bg-white w-full max-w-xs rounded-[32px] p-8 shadow-2xl">
                <h3 class="text-xl font-black mb-6 text-center text-[#4A3F35]">建立新分類</h3>
                <input id="new-folder-name" type="text" placeholder="例如：早餐、咖啡..." class="w-full bg-gray-50 border-none p-4 rounded-2xl text-base font-bold outline-none mb-6">
                <div class="flex gap-3">
                    <button onclick="closeFolderModal()" class="flex-1 py-4 bg-gray-100 rounded-2xl text-sm font-bold text-gray-400">取消</button>
                    <button onclick="saveFolder()" class="flex-1 py-4 bg-amber-500 rounded-2xl text-sm font-bold text-white shadow-lg">建立</button>
                </div>
            </div>
        </div>

        <div id="ticket-modal" class="fixed inset-0 bg-white z-50 hidden overflow-y-auto">
            <div class="px-8 pt-16 pb-12">
                <div class="flex justify-between items-center mb-8">
                    <h2 id="modal-title" class="text-2xl font-black text-[#4A3F35]">存入票券</h2>
                    <button onclick="closeAddModal()" class="text-gray-300"><svg class="w-8 h-8" stroke="currentColor"><use xlink:href="#icon-x"></use></svg></button>
                </div>
                <input type="hidden" id="editing-ticket-id">
                <div class="space-y-6">
                    <div onclick="document.getElementById('file-input').click()" class="aspect-video bg-[#F9F7F4] rounded-[32px] border-2 border-dashed border-[#EAE2D6] flex flex-col items-center justify-center overflow-hidden relative">
                        <input type="file" id="file-input" accept="image/*" class="hidden" onchange="handleFile(this)">
                        <img id="img-output" class="hidden w-full h-full object-cover">
                        <div id="upload-hint" class="text-center">
                            <svg class="w-10 h-10 text-amber-200 mx-auto mb-2" stroke="currentColor"><use xlink:href="#icon-image"></use></svg>
                            <p class="text-xs font-bold text-gray-300 uppercase tracking-widest">點擊上傳截圖</p>
                        </div>
                    </div>
                    <div class="space-y-5">
                        <div class="border-b border-gray-100 pb-2">
                            <label class="text-[0.75rem] font-bold text-amber-500 uppercase">存放分類</label>
                            <select id="ticket-folder-select" class="w-full bg-transparent border-none py-2 text-lg font-bold outline-none"></select>
                        </div>
                        <div class="border-b border-gray-100 pb-2">
                            <label class="text-[0.75rem] font-bold text-amber-500 uppercase">票券名稱</label>
                            <input id="title" type="text" placeholder="例如：拿鐵兌換券..." class="w-full bg-transparent border-none py-2 text-lg font-bold outline-none">
                        </div>
                        <div class="border-b border-gray-100 pb-2">
                            <label class="text-[0.75rem] font-bold text-amber-500 uppercase">序號 (可選)</label>
                            <input id="serial" type="text" placeholder="貼上序號..." class="w-full bg-transparent border-none py-2 text-lg font-bold outline-none text-amber-600">
                        </div>
                        <div class="flex items-center justify-between pt-2">
                            <label class="text-[0.75rem] font-bold text-amber-500 uppercase">有效期限</label>
                            <div class="flex items-center gap-3">
                                <span class="text-xs font-bold text-gray-400">無期限</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="no-expiry-toggle" class="sr-only peer" onchange="toggleExpiryInput()">
                                    <div class="w-11 h-6 bg-gray-100 rounded-full peer toggle-bg border border-gray-200"></div>
                                    <div class="absolute left-1 top-1 bg-white w-4 h-4 rounded-full shadow-sm toggle-dot"></div>
                                </label>
                            </div>
                        </div>
                        <div id="expiry-input-wrapper">
                            <div class="date-input-container">
                                <span id="date-text" class="text-lg font-bold text-gray-300">請選取日期</span>
                                <svg class="w-5 h-5 text-amber-400" stroke="currentColor"><use xlink:href="#icon-calendar"></use></svg>
                                <input id="expiry" type="date" class="native-date-input" onchange="updateDateDisplay(this)">
                            </div>
                        </div>
                    </div>
                    <button onclick="saveTicket()" class="w-full py-6 add-btn text-white rounded-[24px] font-black text-lg mt-4 shadow-xl active:scale-95 transition-all">確認儲存</button>
                </div>
            </div>
        </div>

        <div id="toast" class="fixed bottom-12 left-1/2 -translate-x-1/2 bg-[#4A3F35] text-white px-8 py-3 rounded-full text-sm font-bold opacity-0 transition-all pointer-events-none z-[70]"></div>
    </div>

    <script>
        // 統一資料庫鍵值，並確保有預設分類
        let db = JSON.parse(localStorage.getItem('tikbox_final_db')) || { folders: [], tickets: [] };
        
        // 防呆：如果完全沒分類，幫用戶建一個
        if (db.folders.length === 0) {
            db.folders.push({ id: 'default_folder', name: '一般票券' });
        }

        let currentFolderId = null;
        let currentTab = 'unused';
        let tempImg = null;
        let startX = 0;
        let activeSwipeId = null;

        function zoomImage(src) {
            if (!src) return;
            const lb = document.getElementById('image-lightbox');
            const img = document.getElementById('lightbox-img');
            img.src = src;
            lb.style.display = 'flex';
        }

        function closeLightbox() {
            document.getElementById('image-lightbox').style.display = 'none';
        }

        function render() {
            const folderGrid = document.getElementById('folder-grid');
            const ticketList = document.getElementById('ticket-list');
            
            // 渲染主畫面資料夾
            folderGrid.innerHTML = db.folders.map(f => {
                const count = db.tickets.filter(t => t.folderId === f.id && !t.used).length;
                return `
                    <div onclick="openFolder('${f.id}')" class="folder-card p-6 relative">
                        <button onclick="event.stopPropagation(); deleteFolder('${f.id}')" class="absolute top-4 right-4 text-gray-200">
                            <svg class="w-4 h-4" stroke="currentColor"><use xlink:href="#icon-trash"></use></svg>
                        </button>
                        <div class="w-12 h-12 bg-amber-50 rounded-2xl flex items-center justify-center mb-4">
                            <svg class="w-6 h-6 text-amber-500" stroke="currentColor"><use xlink:href="#icon-folder"></use></svg>
                        </div>
                        <h3 class="text-lg font-black text-[#4A3F35] truncate">${f.name}</h3>
                        <p class="text-sm font-bold text-gray-300 mt-1">${count} 張可用</p>
                    </div>
                `;
            }).join('');

            // 渲染特定資料夾內的票券
            if (currentFolderId) {
                const todayStr = new Date().toISOString().split('T')[0];
                const filtered = db.tickets.filter(t => {
                    if (t.folderId !== currentFolderId) return false;
                    const expired = t.expiry !== 'no-limit' && t.expiry < todayStr;
                    if (currentTab === 'expired') return expired && !t.used;
                    if (currentTab === 'used') return t.used;
                    return !t.used && !expired;
                });

                ticketList.innerHTML = filtered.length === 0 
                    ? `<div class="text-center py-20 text-gray-300 font-bold">此分類尚無票券</div>`
                    : filtered.map((t, idx) => {
                        const diff = getDaysDiff(t.expiry);
                        const isUrgent = !t.used && diff >= 0 && diff <= 3;
                        const dateText = t.expiry === 'no-limit' ? '無期限' : `截止: ${t.expiry}`;
                        const firstChar = t.title.charAt(0) || '?';
                        const avatarStyle = `avatar-${idx % 4}`;

                        return `
                        <div class="swipe-container" id="container-${t.id}">
                            <div class="swipe-action" onclick="deleteTicket('${t.id}')">
                                <svg class="w-6 h-6" stroke="white"><use xlink:href="#icon-trash"></use></svg>
                            </div>
                            <div class="swipe-content p-5" id="content-${t.id}"
                                 ontouchstart="handleTouchStart(event, '${t.id}')" 
                                 ontouchmove="handleTouchMove(event, '${t.id}')" 
                                 ontouchend="handleTouchEnd(event, '${t.id}')">
                                ${isUrgent ? `<div class="absolute top-0 right-0 bg-red-500 text-white text-[10px] px-3 py-1 font-black rounded-bl-xl urgent-badge">即將到期</div>` : ''}
                                <div class="flex items-center gap-4">
                                    <div class="w-14 h-14 rounded-2xl overflow-hidden flex-shrink-0 relative shadow-sm" onclick="zoomImage('${t.image || ''}')">
                                        ${t.image 
                                            ? `<img src="${t.image}" class="w-full h-full object-cover">` 
                                            : `<div class="w-full h-full flex items-center justify-center font-black text-xl ${avatarStyle}">${firstChar}</div>`}
                                    </div>
                                    <div class="flex-1 min-w-0" onclick="zoomImage('${t.image || ''}')">
                                        <h4 class="text-lg font-black text-[#4A3F35] truncate">${t.title}</h4>
                                        <p class="text-xs font-bold ${isUrgent ? 'text-red-500' : (t.expiry === 'no-limit' ? 'text-blue-400' : 'text-amber-500')} uppercase">${dateText}</p>
                                    </div>
                                    <div class="flex gap-2 relative z-30">
                                        <button onclick="openEditModal('${t.id}')" class="w-10 h-10 rounded-full flex items-center justify-center bg-gray-50 text-gray-300">
                                            <svg class="w-5 h-5" stroke="currentColor"><use xlink:href="#icon-edit"></use></svg>
                                        </button>
                                        <button onclick="toggleUsed('${t.id}')" class="w-10 h-10 rounded-full flex items-center justify-center ${t.used ? 'bg-green-500 text-white' : 'bg-amber-500 text-white shadow-md'}">
                                            <svg class="w-5 h-5" stroke="currentColor"><use xlink:href="#icon-check"></use></svg>
                                        </button>
                                    </div>
                                </div>
                                ${t.serial ? `<div class="mt-4 bg-amber-50/50 rounded-xl p-3 flex justify-between items-center"><code class="text-xs font-bold text-amber-700 font-mono truncate mr-2">${t.serial}</code><button onclick="copySerial('${t.serial}')" class="text-[10px] font-black text-amber-500 uppercase bg-white px-2 py-1 rounded-lg shadow-sm">複製</button></div>` : ''}
                            </div>
                        </div>
                    `}).join('');
            }
            
            // 更新 Modal 中的資料夾選項
            document.getElementById('ticket-folder-select').innerHTML = db.folders.map(f => `<option value="${f.id}" ${f.id === currentFolderId ? 'selected' : ''}>${f.name}</option>`).join('');
            
            // 儲存至本地
            localStorage.setItem('tikbox_final_db', JSON.stringify(db));
        }

        function getDaysDiff(targetDate) {
            if (!targetDate || targetDate === 'no-limit') return 999;
            const today = new Date(); today.setHours(0,0,0,0);
            const target = new Date(targetDate); target.setHours(0,0,0,0);
            return Math.ceil((target - today) / (1000 * 60 * 60 * 24));
        }

        function saveTicket() {
            const id = document.getElementById('editing-ticket-id').value;
            const title = document.getElementById('title').value.trim();
            const folderId = document.getElementById('ticket-folder-select').value;
            const isNo = document.getElementById('no-expiry-toggle').checked;
            const exp = document.getElementById('expiry').value;
            
            if (!title) return showToast('請填寫票券名稱');
            if (!isNo && !exp) return showToast('請選取日期或勾選無期限');
            if (!folderId) return showToast('請先建立分類');

            const data = { 
                id: id || Date.now().toString(), 
                title, 
                expiry: isNo ? 'no-limit' : exp, 
                folderId, 
                serial: document.getElementById('serial').value.trim(), 
                image: tempImg, 
                used: false 
            };

            if (id) {
                const idx = db.tickets.findIndex(x => x.id === id);
                data.used = db.tickets[idx].used;
                db.tickets[idx] = data;
            } else {
                db.tickets.push(data);
            }

            closeAddModal();
            render();
            showToast(id ? '已修改' : '已存入');
            
            // 自動跳轉到該票券所屬的分類，讓用戶立刻看到票
            setTimeout(() => openFolder(folderId), 300);
        }

        function openFolder(id) {
            currentFolderId = id;
            const folder = db.folders.find(f => f.id === id);
            if (!folder) { goHome(); return; }
            
            document.getElementById('current-folder-name').innerText = folder.name;
            document.getElementById('back-btn').classList.remove('hidden');
            document.getElementById('breadcrumb').classList.remove('hidden');
            document.getElementById('home-view').classList.add('hidden');
            document.getElementById('folder-view').classList.remove('hidden');
            document.getElementById('app-title').classList.replace('text-3xl', 'text-xl');
            render();
        }

        function goHome() {
            currentFolderId = null;
            document.getElementById('back-btn').classList.add('hidden');
            document.getElementById('breadcrumb').classList.add('hidden');
            document.getElementById('home-view').classList.remove('hidden');
            document.getElementById('folder-view').classList.add('hidden');
            document.getElementById('app-title').classList.replace('text-xl', 'text-3xl');
            render();
        }

        // 基本互動
        function handleTouchStart(e, id) { if (activeSwipeId && activeSwipeId !== id) resetSwipe(); startX = e.touches[0].clientX; activeSwipeId = id; document.getElementById(`content-${id}`).style.transition = 'none'; }
        function handleTouchMove(e, id) { let moveX = e.touches[0].clientX - startX; if (moveX > 0) moveX = 0; if (moveX < -100) moveX = -100; document.getElementById(`content-${id}`).style.transform = `translateX(${moveX}px)`; }
        function handleTouchEnd(e, id) { const content = document.getElementById(`content-${id}`); content.style.transition = 'transform 0.3s ease'; const finalX = e.changedTouches[0].clientX - startX; if (finalX < -50) { content.style.transform = 'translateX(-80px)'; } else { content.style.transform = 'translateX(0)'; activeSwipeId = null; } }
        function resetSwipe() { if (activeSwipeId) { const el = document.getElementById(`content-${activeSwipeId}`); if (el) el.style.transform = 'translateX(0)'; activeSwipeId = null; } }
        function openAddModal() { document.getElementById('modal-title').innerText = "存入票券"; document.getElementById('editing-ticket-id').value = ""; document.getElementById('title').value = ""; document.getElementById('serial').value = ""; document.getElementById('no-expiry-toggle').checked = false; document.getElementById('expiry').value = ""; tempImg = null; document.getElementById('img-output').classList.add('hidden'); document.getElementById('upload-hint').classList.remove('hidden'); toggleExpiryInput(); updateDateDisplay(document.getElementById('expiry')); document.getElementById('ticket-modal').classList.remove('hidden'); }
        function closeAddModal() { document.getElementById('ticket-modal').classList.add('hidden'); }
        function openFolderModal() { document.getElementById('folder-modal').classList.remove('hidden'); }
        function closeFolderModal() { document.getElementById('folder-modal').classList.add('hidden'); }
        function saveFolder() { const n = document.getElementById('new-folder-name').value.trim(); if(n){ db.folders.push({id:Date.now().toString(), name:n}); render(); closeFolderModal(); document.getElementById('new-folder-name').value = ""; }}
        function deleteFolder(id) { if(confirm('將刪除分類及其中所有票券？')){ db.folders = db.folders.filter(x=>x.id!==id); db.tickets = db.tickets.filter(x=>x.folderId!==id); render(); }}
        function deleteTicket(id) { if(confirm('確定刪除此票券？')){ db.tickets = db.tickets.filter(x=>x.id!==id); render(); } else { resetSwipe(); }}
        function toggleUsed(id) { const t=db.tickets.find(x=>x.id===id); if(t){ t.used=!t.used; render(); }}
        function setTab(t) { currentTab=t; render(); }
        function toggleExpiryInput() { document.getElementById('expiry-input-wrapper').style.display = document.getElementById('no-expiry-toggle').checked?'none':'block'; }
        function updateDateDisplay(i) { const d=document.getElementById('date-text'); d.innerText=i.value||"請選取日期"; d.classList.toggle('text-gray-300', !i.value); d.classList.toggle('text-[#4A3F35]', !!i.value); }
        function showToast(m) { const t=document.getElementById('toast'); t.innerText=m; t.classList.add('opacity-100'); setTimeout(()=>t.classList.remove('opacity-100'),2000); }
        function handleFile(i) { const r=new FileReader(); r.onload=e=>{ tempImg=e.target.result; document.getElementById('img-output').src=tempImg; document.getElementById('img-output').classList.remove('hidden'); document.getElementById('upload-hint').classList.add('hidden'); }; r.readAsDataURL(i.files[0]); }
        function copySerial(t) { const el=document.createElement('textarea'); el.value=t; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el); showToast('已複製序號'); }
        function openEditModal(id) { resetSwipe(); const t = db.tickets.find(x => x.id === id); document.getElementById('modal-title').innerText = "編輯票券"; document.getElementById('editing-ticket-id').value = t.id; document.getElementById('title').value = t.title; document.getElementById('serial').value = t.serial || ''; document.getElementById('ticket-folder-select').value = t.folderId; document.getElementById('no-expiry-toggle').checked = t.expiry === 'no-limit'; document.getElementById('expiry').value = t.expiry === 'no-limit' ? '' : t.expiry; tempImg = t.image; const out = document.getElementById('img-output'); if(tempImg) { out.src = tempImg; out.classList.remove('hidden'); document.getElementById('upload-hint').classList.add('hidden'); } toggleExpiryInput(); updateDateDisplay(document.getElementById('expiry')); document.getElementById('ticket-modal').classList.remove('hidden'); }

        window.onclick = (e) => { if (!e.target.closest('.swipe-container')) resetSwipe(); };
        window.onload = () => { render(); };
    </script>
</body>
</html>
